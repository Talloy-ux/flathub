From f7c8e591949f31635e6aa04f6794509be1be6abb Mon Sep 17 00:00:00 2001
Message-Id: <f7c8e591949f31635e6aa04f6794509be1be6abb.1612803844.git.marksvc@gmail.com>
In-Reply-To: <2139248f79573dcdbf58bf2f45bfd811d651bdc3.1612803844.git.marksvc@gmail.com>
References: <2139248f79573dcdbf58bf2f45bfd811d651bdc3.1612803844.git.marksvc@gmail.com>
From: MarkS <marksvc@gmail.com>
Date: Mon, 8 Feb 2021 10:50:52 -0600
Subject: [PATCH 3/6] Look for files in prefix, not just /usr

- To support /app for flatpak.

Change-Id: I6249dbbe9e447c796c5255d734f8f94c85a0da96
---
 Build/Linux.targets                                      | 8 ++++----
 Build/SetupInclude.targets                               | 9 +++++++++
 Build/mkall.targets                                      | 4 ++--
 Src/Common/Controls/XMLViews/XMLViews.csproj             | 4 ++--
 Src/Common/ScriptureUtils/ScriptureUtils.csproj          | 2 +-
 Src/FwCoreDlgs/FwCoreDlgs.csproj                         | 4 ++--
 Src/FwCoreDlgs/FwCoreDlgsTests/FwCoreDlgsTests.csproj    | 4 ++--
 Src/LexText/Interlinear/ITextDll.csproj                  | 4 ++--
 .../Interlinear/ITextDllTests/ITextDllTests.csproj       | 4 ++--
 Src/LexText/LexTextControls/LexTextControls.csproj       | 4 ++--
 Src/LexText/Lexicon/LexEdDll.csproj                      | 2 +-
 Src/LexText/Morphology/MorphologyEditorDll.csproj        | 2 +-
 Src/ParatextImport/ParatextImport.csproj                 | 4 ++--
 .../ParatextImportTests/ParatextImportTests.csproj       | 4 ++--
 Src/Utilities/SfmToXml/Sfm2Xml.csproj                    | 4 ++--
 Src/Utilities/SfmToXml/Sfm2XmlTests/Sfm2XmlTests.csproj  | 2 +-
 16 files changed, 37 insertions(+), 28 deletions(-)

diff --git a/fw/Build/Linux.targets b/fw/Build/Linux.targets
index 8ee72bb7..ae012d42 100644
--- a/fw/Build/Linux.targets
+++ b/fw/Build/Linux.targets
@@ -76,28 +76,28 @@
 			  DestinationFolder="$(dir-outputBase)"
 			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"
 			  Condition="'$(action)'!='clean'"/>
-		<CreateItem Include="/usr/lib/fieldworks/*.so">
+		<CreateItem Include="$(installation_prefix)/lib/fieldworks/*.so">
 			<Output TaskParameter="Include" ItemName="LinuxECShlibs"/>
 		</CreateItem>
 		<Copy SourceFiles="@(LinuxECShlibs)"
 			  DestinationFolder="$(dir-outputBase)"
 			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"
 			  Condition="'$(action)'!='clean'"/>
-		<CreateItem Include="/usr/lib/fieldworks/*.dll">
+		<CreateItem Include="$(installation_prefix)/lib/fieldworks/*.dll">
 			<Output TaskParameter="Include" ItemName="LinuxECLibs"/>
 		</CreateItem>
 		<Copy SourceFiles="@(LinuxECLibs)"
 			  DestinationFolder="$(dir-outputBase)"
 			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"
 			  Condition="'$(action)'!='clean'"/>
-		<CreateItem Include="/usr/lib/fieldworks/*.dll.config">
+		<CreateItem Include="$(installation_prefix)/lib/fieldworks/*.dll.config">
 			<Output TaskParameter="Include" ItemName="LinuxECConfigs"/>
 		</CreateItem>
 		<Copy SourceFiles="@(LinuxECConfigs)"
 			  DestinationFolder="$(dir-outputBase)"
 			  SkipUnchangedFiles="true" OverwriteReadOnlyFiles="true"
 			  Condition="'$(action)'!='clean'"/>
-		<CreateItem Include="/usr/lib/fieldworks/EC/Plugins/*.xml">
+		<CreateItem Include="$(installation_prefix)/lib/fieldworks/EC/Plugins/*.xml">
 			<Output TaskParameter="Include" ItemName="LinuxECPlugins"/>
 		</CreateItem>
 		<Copy SourceFiles="@(LinuxECPlugins)"
diff --git a/fw/Build/SetupInclude.targets b/fw/Build/SetupInclude.targets
index c9aa583e..f8966867 100644
--- a/fw/Build/SetupInclude.targets
+++ b/fw/Build/SetupInclude.targets
@@ -214,6 +214,15 @@
 	  <Output TaskParameter="Value" PropertyName="icu_lib"/>
 	</CreateProperty>
 
+	<!-- Area of filesystem where FieldWorks and its dependencies are being installed. This
+	is /usr when installed from a .deb package, or /app when using flatpak. -->
+	<CreateProperty Condition="'$(OS)'!='Windows_NT'" Value="/usr">
+	  <Output TaskParameter="Value" PropertyName="installation_prefix"/>
+	</CreateProperty>
+	<CreateProperty Condition="'$(OS)'=='Windows_NT'" Value="">
+	  <Output TaskParameter="Value" PropertyName="installation_prefix"/>
+	</CreateProperty>
+
 <!--<if test="${not property::exists('dir.nunitreport')}">-->
 <!--	<property name="dir.nunitreport" value="${nant::get-base-directory()}/extensions/common/neutral/FwTasks/NUnit.Report"/>-->
 <!--</if>-->
diff --git a/fw/Build/mkall.targets b/fw/Build/mkall.targets
index ced9ba9e..b2e61cbb 100644
--- a/fw/Build/mkall.targets
+++ b/fw/Build/mkall.targets
@@ -648,11 +648,11 @@
 			Condition="'$(OS)'=='Windows_NT'"/>
 		<WriteRegistry Hive="CurrentUser"
 			Key="$(BUILDAGENT_HKCU)SOFTWARE\SIL\SilEncConverters40\RootDir"
-			Value="/usr/lib/fieldworks"
+			Value="$(installation_prefix)/lib/fieldworks"
 			Condition="'$(OS)'=='Unix'"/>
 		<WriteRegistry Hive="CurrentUser"
 			Key="$(BUILDAGENT_HKCU)SOFTWARE\SIL\SilEncConverters40\DeveloperPluginDir"
-			Value="/usr/lib/fieldworks/EC/Plugins"
+			Value="$(installation_prefix)/lib/fieldworks/EC/Plugins"
 			Condition="'$(OS)'=='Unix'"/>
 
 		<MakeDir Directories="$(fwrt)/DistFiles/SIL/Repository"/>
diff --git a/fw/Src/Common/Controls/XMLViews/XMLViews.csproj b/fw/Src/Common/Controls/XMLViews/XMLViews.csproj
index 09128ea1..33acf994 100644
--- a/fw/Src/Common/Controls/XMLViews/XMLViews.csproj
+++ b/fw/Src/Common/Controls/XMLViews/XMLViews.csproj
@@ -235,7 +235,7 @@
     </Reference>
     <Reference Include="ECInterfaces" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/ECInterfaces.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/ECInterfaces.dll</HintPath>
     </Reference>
     <Reference Include="SilEncConverters40, Version=4.0.0.0, Culture=neutral, PublicKeyToken=f1447bae1e63f485, processorArchitecture=x86" Condition="'$(OS)'!='Unix'">
       <SpecificVersion>False</SpecificVersion>
@@ -243,7 +243,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/Common/ScriptureUtils/ScriptureUtils.csproj b/fw/Src/Common/ScriptureUtils/ScriptureUtils.csproj
index 79049446..6e211cb5 100644
--- a/fw/Src/Common/ScriptureUtils/ScriptureUtils.csproj
+++ b/fw/Src/Common/ScriptureUtils/ScriptureUtils.csproj
@@ -177,7 +177,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="System">
       <Name>System</Name>
diff --git a/fw/Src/FwCoreDlgs/FwCoreDlgs.csproj b/fw/Src/FwCoreDlgs/FwCoreDlgs.csproj
index 31a40e28..1c00e03d 100644
--- a/fw/Src/FwCoreDlgs/FwCoreDlgs.csproj
+++ b/fw/Src/FwCoreDlgs/FwCoreDlgs.csproj
@@ -167,7 +167,7 @@
     </Reference>
     <Reference Include="ECInterfaces" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/ECInterfaces.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/ECInterfaces.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel">
       <Name>SIL.LCModel</Name>
@@ -239,7 +239,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/FwCoreDlgs/FwCoreDlgsTests/FwCoreDlgsTests.csproj b/fw/Src/FwCoreDlgs/FwCoreDlgsTests/FwCoreDlgsTests.csproj
index 126d3a85..617f33a7 100644
--- a/fw/Src/FwCoreDlgs/FwCoreDlgsTests/FwCoreDlgsTests.csproj
+++ b/fw/Src/FwCoreDlgs/FwCoreDlgsTests/FwCoreDlgsTests.csproj
@@ -180,7 +180,7 @@
     </Reference>
     <Reference Include="ECInterfaces" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/ECInterfaces.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/ECInterfaces.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel">
       <Name>SIL.LCModel</Name>
@@ -254,7 +254,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/LexText/Interlinear/ITextDll.csproj b/fw/Src/LexText/Interlinear/ITextDll.csproj
index fcb3e9ac..603fbcad 100644
--- a/fw/Src/LexText/Interlinear/ITextDll.csproj
+++ b/fw/Src/LexText/Interlinear/ITextDll.csproj
@@ -237,7 +237,7 @@
     </Reference>
     <Reference Include="ECInterfaces" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/ECInterfaces.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/ECInterfaces.dll</HintPath>
     </Reference>
     <Reference Include="FwCoreDlgControls, Version=6.9.0.0, Culture=neutral, PublicKeyToken=null">
       <SpecificVersion>False</SpecificVersion>
@@ -257,7 +257,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/LexText/Interlinear/ITextDllTests/ITextDllTests.csproj b/fw/Src/LexText/Interlinear/ITextDllTests/ITextDllTests.csproj
index 8c5297b4..f3408424 100644
--- a/fw/Src/LexText/Interlinear/ITextDllTests/ITextDllTests.csproj
+++ b/fw/Src/LexText/Interlinear/ITextDllTests/ITextDllTests.csproj
@@ -175,7 +175,7 @@
     </Reference>
     <Reference Include="ECInterfaces" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/ECInterfaces.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/ECInterfaces.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel, Version=9.0.0.0, Culture=neutral, processorArchitecture=x86">
       <SpecificVersion>False</SpecificVersion>
@@ -246,7 +246,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/LexText/LexTextControls/LexTextControls.csproj b/fw/Src/LexText/LexTextControls/LexTextControls.csproj
index 5ee6e53a..43933809 100644
--- a/fw/Src/LexText/LexTextControls/LexTextControls.csproj
+++ b/fw/Src/LexText/LexTextControls/LexTextControls.csproj
@@ -151,7 +151,7 @@
     </Reference>
     <Reference Include="ECInterfaces" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/ECInterfaces.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/ECInterfaces.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel">
       <Name>SIL.LCModel</Name>
@@ -245,7 +245,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/LexText/Lexicon/LexEdDll.csproj b/fw/Src/LexText/Lexicon/LexEdDll.csproj
index 78c39a48..50372e15 100644
--- a/fw/Src/LexText/Lexicon/LexEdDll.csproj
+++ b/fw/Src/LexText/Lexicon/LexEdDll.csproj
@@ -235,7 +235,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/LexText/Morphology/MorphologyEditorDll.csproj b/fw/Src/LexText/Morphology/MorphologyEditorDll.csproj
index 17f10bc9..52866291 100644
--- a/fw/Src/LexText/Morphology/MorphologyEditorDll.csproj
+++ b/fw/Src/LexText/Morphology/MorphologyEditorDll.csproj
@@ -223,7 +223,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/ParatextImport/ParatextImport.csproj b/fw/Src/ParatextImport/ParatextImport.csproj
index 85aac9c9..18be08ef 100644
--- a/fw/Src/ParatextImport/ParatextImport.csproj
+++ b/fw/Src/ParatextImport/ParatextImport.csproj
@@ -100,7 +100,7 @@
     </Reference>
     <Reference Include="ECInterfaces" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/ECInterfaces.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/ECInterfaces.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel, Version=9.0.0.0, Culture=neutral, processorArchitecture=x86">
       <HintPath>..\..\Output\Debug\SIL.LCModel.dll</HintPath>
@@ -156,7 +156,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/ParatextImport/ParatextImportTests/ParatextImportTests.csproj b/fw/Src/ParatextImport/ParatextImportTests/ParatextImportTests.csproj
index 14830364..5e7175a9 100644
--- a/fw/Src/ParatextImport/ParatextImportTests/ParatextImportTests.csproj
+++ b/fw/Src/ParatextImport/ParatextImportTests/ParatextImportTests.csproj
@@ -102,7 +102,7 @@
     </Reference>
     <Reference Include="ECInterfaces" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/ECInterfaces.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/ECInterfaces.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel, Version=9.0.0.0, Culture=neutral, processorArchitecture=x86">
       <SpecificVersion>False</SpecificVersion>
@@ -194,7 +194,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="SIL.LCModel.Utils, Version=9.0.0.0, Culture=neutral, processorArchitecture=MSIL">
       <SpecificVersion>False</SpecificVersion>
diff --git a/fw/Src/Utilities/SfmToXml/Sfm2Xml.csproj b/fw/Src/Utilities/SfmToXml/Sfm2Xml.csproj
index 5becc4cd..923a9430 100644
--- a/fw/Src/Utilities/SfmToXml/Sfm2Xml.csproj
+++ b/fw/Src/Utilities/SfmToXml/Sfm2Xml.csproj
@@ -148,7 +148,7 @@
     </Reference>
     <Reference Include="ECInterfaces" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/ECInterfaces.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/ECInterfaces.dll</HintPath>
     </Reference>
     <Reference Include="SilEncConverters40, Version=4.0.0.0, Culture=neutral, PublicKeyToken=f1447bae1e63f485, processorArchitecture=x86" Condition="'$(OS)'!='Unix'">
       <SpecificVersion>False</SpecificVersion>
@@ -156,7 +156,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="System" />
     <Reference Include="System.Core" />
diff --git a/fw/Src/Utilities/SfmToXml/Sfm2XmlTests/Sfm2XmlTests.csproj b/fw/Src/Utilities/SfmToXml/Sfm2XmlTests/Sfm2XmlTests.csproj
index 6bb1a808..32134ed9 100644
--- a/fw/Src/Utilities/SfmToXml/Sfm2XmlTests/Sfm2XmlTests.csproj
+++ b/fw/Src/Utilities/SfmToXml/Sfm2XmlTests/Sfm2XmlTests.csproj
@@ -78,7 +78,7 @@
     </Reference>
     <Reference Include="SilEncConverters40" Condition="'$(OS)'=='Unix'">
       <SpecificVersion>False</SpecificVersion>
-      <HintPath>/usr/lib/fieldworks/SilEncConverters40.dll</HintPath>
+      <HintPath>$(installation_prefix)/lib/fieldworks/SilEncConverters40.dll</HintPath>
     </Reference>
     <Reference Include="System" />
     <Reference Include="System.Core" />
-- 
2.25.1

