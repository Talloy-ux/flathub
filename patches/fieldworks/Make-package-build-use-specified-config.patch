From 45da80b13de53177c35e65457dcf0536b3baf903 Mon Sep 17 00:00:00 2001
Message-Id: <45da80b13de53177c35e65457dcf0536b3baf903.1616168131.git.marksvc@gmail.com>
From: MarkS <marksvc@gmail.com>
Date: Fri, 19 Mar 2021 10:35:24 -0500
Subject: [PATCH] Make package build use specified config

To be possible to build a Debug flatpak package.

Change-Id: I049cacfb293822a9fe2bf5e9862dd9e389c14d52
---
 Makefile | 15 ++++++++-------
 1 file changed, 8 insertions(+), 7 deletions(-)

diff --git a/Makefile b/Makefile
index 7ee0585c..037c1c95 100644
--- a/fw/Makefile
+++ b/fw/Makefile
@@ -19,6 +19,7 @@ SHELL=/bin/bash
 BITS := $(shell test `arch` = x86_64 && echo 64 || echo 32)
 PLATFORM := $(shell test `arch` = x86_64 && echo x64 || echo x86)
 INSTALLATION_PREFIX ?= /usr
+BUILD_CONFIG ?= Release
 
 all:
 
@@ -374,31 +375,31 @@ check-have-build-dependencies:
 # As of 2017-03-27, localize is more likely to crash running on mono 3 than to actually have a real localization problem. So try it a few times so that a random crash doesn't fail a packaging job that has been running for over an hour.
 # Make the lcm artifacts dir so it is a valid path for later processing appending things like '/..'.
 Fw-build-package: check-have-build-dependencies
-	export LcmLocalArtifactsDir="$(BUILD_ROOT)/../liblcm/artifacts/Release" \
+	export LcmLocalArtifactsDir="$(BUILD_ROOT)/../liblcm/artifacts/$(BUILD_CONFIG)" \
 		&& mkdir -p $$LcmLocalArtifactsDir \
 		&& . environ \
 		&& cd $(BUILD_ROOT)/Build \
 		&& $(BUILD_TOOL) /t:refreshTargets /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS) \
-		&& $(BUILD_TOOL) '/t:remakefw' /property:config=release /property:Platform=$(PLATFORM) /property:packaging=yes /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS) \
-		&& ./multitry $(BUILD_TOOL) '/t:localize-binaries' /property:config=release /property:packaging=yes /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS)
+		&& $(BUILD_TOOL) '/t:remakefw' /property:config=$(BUILD_CONFIG) /property:Platform=$(PLATFORM) /property:packaging=yes /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS) \
+		&& ./multitry $(BUILD_TOOL) '/t:localize-binaries' /property:config=$(BUILD_CONFIG) /property:packaging=yes /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS)
 	if [ "$(FW_PACKAGE_DEBUG)" = "true" ]; then find "$(BUILD_ROOT)/.."; fi
 
 Fw-build-package-fdo: check-have-build-dependencies
 	cd $(BUILD_ROOT)/Build \
 		&& $(BUILD_TOOL) /t:refreshTargets /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS) \
-		&& $(BUILD_TOOL) '/t:build4package-fdo' /property:config=release /property:packaging=yes /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS)
+		&& $(BUILD_TOOL) '/t:build4package-fdo' /property:config=$(BUILD_CONFIG) /property:packaging=yes /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS)
 
 RestoreNuGetPackages:
 	. environ \
 		&& cd Build \
-		&& $(BUILD_TOOL) /t:RestoreNuGetPackages /property:config=release \
+		&& $(BUILD_TOOL) /t:RestoreNuGetPackages /property:config=$(BUILD_CONFIG) \
 			/property:packaging=yes /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS)
 
 # Begin localization section
 
 localize-source: RestoreNuGetPackages
 	. environ && \
-	(cd Build && $(BUILD_TOOL) /t:localize-source /property:config=release /property:packaging=yes /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS))
+	(cd Build && $(BUILD_TOOL) /t:localize-source /property:config=$(BUILD_CONFIG) /property:packaging=yes /property:installation_prefix=$(INSTALLATION_PREFIX) $(MSBUILD_ARGS))
 	# Remove symbolic links from Output - we don't want those in the source package
 	find Output -type l -delete
 	# Copy localization files to Localizations folder so that they survive a 'clean'
@@ -425,7 +426,7 @@ l10n-install:
 	for LOCALE in $(LOCALIZATIONS); do \
 		DESTINATION=$(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks-l10n-$${LOCALE,,} ;\
 		install -d $$DESTINATION ;\
-		install -m 644 Output/Release/$$LOCALE/*.dll $$DESTINATION/ ;\
+		install -m 644 Output/$(BUILD_CONFIG)/$$LOCALE/*.dll $$DESTINATION/ ;\
 		install -m 644 "$(BUILD_ROOT)/DistFiles/CommonLocalizations/Palaso.$$LOCALE.xlf" $$DESTINATION/ ;\
 		install -m 644 "$(BUILD_ROOT)/DistFiles/CommonLocalizations/Chorus.$$LOCALE.xlf" $$DESTINATION/ ;\
 		install -m 644 "$(BUILD_ROOT)/DistFiles/Language Explorer/Configuration/strings-$$LOCALE.xml" $$DESTINATION/ ;\
-- 
2.25.1

