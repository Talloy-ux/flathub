From cad912a5e731378a70928c75c67c052497cb698a Mon Sep 17 00:00:00 2001
Message-Id: <cad912a5e731378a70928c75c67c052497cb698a.1612803844.git.marksvc@gmail.com>
In-Reply-To: <2139248f79573dcdbf58bf2f45bfd811d651bdc3.1612803844.git.marksvc@gmail.com>
References: <2139248f79573dcdbf58bf2f45bfd811d651bdc3.1612803844.git.marksvc@gmail.com>
From: MarkS <marksvc@gmail.com>
Date: Fri, 5 Feb 2021 12:30:56 -0600
Subject: [PATCH 2/6] Allow installing to custom prefix

For flatpak.

Change-Id: Idf2e39b380749c926dcbc23ee6f9a1bb2c1c3d6c
---
 Makefile | 147 ++++++++++++++++++++++++++++---------------------------
 1 file changed, 74 insertions(+), 73 deletions(-)

diff --git a/Makefile b/Makefile
index 8778fcb8..4d27ea4c 100644
--- a/fw/Makefile
+++ b/fw/Makefile
@@ -18,6 +18,7 @@ include $(BUILD_ROOT)/Bld/_init.mak.lnx
 SHELL=/bin/bash
 BITS := $(shell test `arch` = x86_64 && echo 64 || echo 32)
 PLATFORM := $(shell test `arch` = x86_64 && echo x64 || echo x86)
+INSTALLATION_PREFIX ?= /usr
 
 all:
 
@@ -88,113 +89,113 @@ manpage-clean:
 
 install-tree-fdo:
 	# Create directories
-	install -d $(DESTDIR)/usr/lib/fieldworks
-	install -d $(DESTDIR)/usr/lib/fieldworks/Firefox-Linux$(BITS)
-	install -d $(DESTDIR)/usr/share/fieldworks
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/Firefox-Linux$(BITS)
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
 	install -d $(DESTDIR)/var/lib/fieldworks
 	# Install libraries and their support files
-	install -m 644 $(OUT_DIR)/*.{dll*,so} $(DESTDIR)/usr/lib/fieldworks
-	install -m 644 $(OUT_DIR)/Firefox-Linux$(BITS)/*.* $(DESTDIR)/usr/lib/fieldworks/Firefox-Linux$(BITS)
-	install -m 644 $(OUT_DIR)/{*.compmap,components.map} $(DESTDIR)/usr/lib/fieldworks
+	install -m 644 $(OUT_DIR)/*.{dll*,so} $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install -m 644 $(OUT_DIR)/Firefox-Linux$(BITS)/*.* $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/Firefox-Linux$(BITS)
+	install -m 644 $(OUT_DIR)/{*.compmap,components.map} $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
 	# Install executables and scripts
-	install Lib/linux/setup-user $(DESTDIR)/usr/share/fieldworks/
+	install Lib/linux/setup-user $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/
 	# Install content and plug-ins
 	# For reasons I don't understand we need strings-en.txt otherwise the tests fail when run from xbuild
-	install -m 644 DistFiles/strings-en.txt $(DESTDIR)/usr/share/fieldworks
-	install -m 644 DistFiles/*.{xml,map,tec,dtd} $(DESTDIR)/usr/share/fieldworks
-	cp -pdr DistFiles/{Ethnologue,Icu54,Templates} $(DESTDIR)/usr/share/fieldworks
+	install -m 644 DistFiles/strings-en.txt $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
+	install -m 644 DistFiles/*.{xml,map,tec,dtd} $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
+	cp -pdr DistFiles/{Ethnologue,Icu54,Templates} $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
 	# Remove unwanted items
 	case $(ARCH) in i686) OTHERWIDTH=64;; x86_64) OTHERWIDTH=32;; esac; \
-	rm -f $(DESTDIR)/usr/lib/fieldworks/lib{xample,patr}$$OTHERWIDTH.so
-	rm -f $(DESTDIR)/usr/lib/fieldworks/lib{ecdriver,IcuConvEC,IcuRegexEC,IcuTranslitEC,PyScriptEncConverter}*.so
-	rm -f $(DESTDIR)/usr/lib/fieldworks/{AIGuesserEC,CcEC,IcuEC,PerlExpressionEC,PyScriptEC,SilEncConverters40,ECInterfaces}.dll{,.config}
-	rm -f $(DESTDIR)/usr/lib/fieldworks/libTECkit{,_Compiler}*.so
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/lib{xample,patr}$$OTHERWIDTH.so
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/lib{ecdriver,IcuConvEC,IcuRegexEC,IcuTranslitEC,PyScriptEncConverter}*.so
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/{AIGuesserEC,CcEC,IcuEC,PerlExpressionEC,PyScriptEC,SilEncConverters40,ECInterfaces}.dll{,.config}
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/libTECkit{,_Compiler}*.so
 
 install-tree: fieldworks-flex.1.gz unicodechareditor.1.gz install-tree-fdo
 	if [ "$(FW_PACKAGE_DEBUG)" = "true" ]; then find "$(BUILD_ROOT)" "$(DESTDIR)"; fi
 	# Create directories
-	install -d $(DESTDIR)/usr/bin
-	install -d $(DESTDIR)/usr/lib/fieldworks
-	install -d $(DESTDIR)/usr/share/fieldworks
-	install -d $(DESTDIR)/usr/share/man/man1
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/bin
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/share/man/man1
 	install -d $(DESTDIR)/etc/profile.d
 	# Install libraries and their support files
-	install -m 644 DistFiles/*.{dll*,so} $(DESTDIR)/usr/lib/fieldworks
-	install -m 644 DistFiles/Linux/*.so $(DESTDIR)/usr/lib/fieldworks
-	install -m 644 $(OUT_DIR)/*.{dll*,so} $(DESTDIR)/usr/lib/fieldworks
+	install -m 644 DistFiles/*.{dll*,so} $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install -m 644 DistFiles/Linux/*.so $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install -m 644 $(OUT_DIR)/*.{dll*,so} $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
 	# Install executables and scripts
-	install $(OUT_DIR)/*.exe $(DESTDIR)/usr/lib/fieldworks
-	install DistFiles/*.exe $(DESTDIR)/usr/lib/fieldworks
-	install Bin/ReadKey.exe $(DESTDIR)/usr/lib/fieldworks
-	install Bin/WriteKey.exe $(DESTDIR)/usr/lib/fieldworks
-	install Lib/linux/fieldworks-flex $(DESTDIR)/usr/bin
-	install Lib/linux/unicodechareditor $(DESTDIR)/usr/bin
-	install Lib/linux/{cpol-action,run-app,extract-userws.xsl,launch-xchm} $(DESTDIR)/usr/lib/fieldworks
-	install -m 644 environ{,-xulrunner} $(DESTDIR)/usr/lib/fieldworks
+	install $(OUT_DIR)/*.exe $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install DistFiles/*.exe $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install Bin/ReadKey.exe $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install Bin/WriteKey.exe $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install Lib/linux/fieldworks-flex $(DESTDIR)$(INSTALLATION_PREFIX)/bin
+	install Lib/linux/unicodechareditor $(DESTDIR)$(INSTALLATION_PREFIX)/bin
+	install Lib/linux/{cpol-action,run-app,extract-userws.xsl,launch-xchm} $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install -m 644 environ{,-xulrunner} $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
 	install -m 644 Lib/linux/fieldworks.sh $(DESTDIR)/etc/profile.d
 	# Install content and plug-ins
-	install -m 644 DistFiles/*.{txt,reg} $(DESTDIR)/usr/share/fieldworks
-	cp -pdr DistFiles/{"Editorial Checks",EncodingConverters} $(DESTDIR)/usr/share/fieldworks
-	cp -pdr DistFiles/{Helps,Fonts,Graphite,Keyboards,"Language Explorer",Parts} $(DESTDIR)/usr/share/fieldworks
+	install -m 644 DistFiles/*.{txt,reg} $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
+	cp -pdr DistFiles/{"Editorial Checks",EncodingConverters} $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
+	cp -pdr DistFiles/{Helps,Fonts,Graphite,Keyboards,"Language Explorer",Parts} $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
 	# Install man pages
-	install -m 644 *.1.gz $(DESTDIR)/usr/share/man/man1
+	install -m 644 *.1.gz $(DESTDIR)$(INSTALLATION_PREFIX)/share/man/man1
 	# Handle the Converter files
-	mv $(DESTDIR)/usr/lib/fieldworks/{Converter.exe,ConvertLib.dll,ConverterConsole.exe} $(DESTDIR)/usr/share/fieldworks
+	mv $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/{Converter.exe,ConvertLib.dll,ConverterConsole.exe} $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
 	# Remove unwanted items
-	rm -f $(DESTDIR)/usr/lib/fieldworks/DevComponents.DotNetBar.dll
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/DevComponents.DotNetBar.dll
 	case $(ARCH) in i686) OTHERWIDTH=64;; x86_64) OTHERWIDTH=32;; esac; \
-	rm -f $(DESTDIR)/usr/lib/fieldworks/lib{xample,patr}$$OTHERWIDTH.so
-	rm -f $(DESTDIR)/usr/lib/fieldworks/lib{ecdriver,IcuConvEC,IcuRegexEC,IcuTranslitEC,PyScriptEncConverter}*.so
-	rm -f $(DESTDIR)/usr/lib/fieldworks/{AIGuesserEC,CcEC,IcuEC,PerlExpressionEC,PyScriptEC,SilEncConverters40,ECInterfaces}.dll{,.config}
-	rm -f $(DESTDIR)/usr/lib/fieldworks/libTECkit{,_Compiler}*.so
-	rm -Rf $(DESTDIR)/usr/lib/share/fieldworks/Icu54/tools
-	rm -f $(DESTDIR)/usr/lib/share/fieldworks/Icu54/Keyboards
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/lib{xample,patr}$$OTHERWIDTH.so
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/lib{ecdriver,IcuConvEC,IcuRegexEC,IcuTranslitEC,PyScriptEncConverter}*.so
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/{AIGuesserEC,CcEC,IcuEC,PerlExpressionEC,PyScriptEC,SilEncConverters40,ECInterfaces}.dll{,.config}
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/libTECkit{,_Compiler}*.so
+	rm -Rf $(DESTDIR)$(INSTALLATION_PREFIX)/lib/share/fieldworks/Icu54/tools
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/share/fieldworks/Icu54/Keyboards
 	# Windows dll and exe files.
-	rm -f $(DESTDIR)/usr/lib/fieldworks/{aspell-15,iconv,libglib-2.0-0,libglib-2.0-0-vs8,libgmodule-2.0-0,libgmodule-2.0-0-vs8,TextFormStorage,unicows,wrtXML,xample32,xample64,XceedZip,xmlparse_u}.dll
-	rm -f $(DESTDIR)/usr/lib/fieldworks/{SFconv,TxtConv,vs_piaredist,ZEdit}.exe
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/{aspell-15,iconv,libglib-2.0-0,libglib-2.0-0-vs8,libgmodule-2.0-0,libgmodule-2.0-0-vs8,TextFormStorage,unicows,wrtXML,xample32,xample64,XceedZip,xmlparse_u}.dll
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/{SFconv,TxtConv,vs_piaredist,ZEdit}.exe
 	# Remove localization data that came from "DistFiles/Language Explorer", which is handled separately by l10n-install
-	rm -f $(DESTDIR)/usr/share/fieldworks/Language\ Explorer/Configuration/strings-*.xml
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/Language\ Explorer/Configuration/strings-*.xml
 	# Except we still want English :-) (this also seems like a sensible place to install English .xlf files for common libraries)
-	mkdir -p "$(DESTDIR)/usr/share/fieldworks/CommonLocalizations"
-	install -m 644 DistFiles/CommonLocalizations/*.en.xlf $(DESTDIR)/usr/share/fieldworks/CommonLocalizations
-	install -m 644 DistFiles/Language\ Explorer/Configuration/strings-en.xml $(DESTDIR)/usr/share/fieldworks/Language\ Explorer/Configuration
+	mkdir -p "$(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/CommonLocalizations"
+	install -m 644 DistFiles/CommonLocalizations/*.en.xlf $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/CommonLocalizations
+	install -m 644 DistFiles/Language\ Explorer/Configuration/strings-en.xml $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/Language\ Explorer/Configuration
 
 install-menuentries:
 	# Add to Applications menu
-	install -d $(DESTDIR)/usr/share/pixmaps
-	install -d $(DESTDIR)/usr/share/icons/hicolor/64x64/apps
-	install -d $(DESTDIR)/usr/share/icons/hicolor/128x128/apps
-	install -d $(DESTDIR)/usr/share/applications
-	install -m 644 Src/LexText/LexTextExe/LT.png $(DESTDIR)/usr/share/pixmaps/fieldworks-flex.png
-	install -m 644 Src/LexText/LexTextExe/LT64.png $(DESTDIR)/usr/share/icons/hicolor/64x64/apps/fieldworks-flex.png
-	install -m 644 Src/LexText/LexTextExe/LT128.png $(DESTDIR)/usr/share/icons/hicolor/128x128/apps/fieldworks-flex.png
-	desktop-file-install --dir $(DESTDIR)/usr/share/applications Lib/linux/fieldworks-applications.desktop
-	desktop-file-install --dir $(DESTDIR)/usr/share/applications Lib/linux/unicodechareditor.desktop
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/share/pixmaps
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/share/icons/hicolor/64x64/apps
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/share/icons/hicolor/128x128/apps
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/share/applications
+	install -m 644 Src/LexText/LexTextExe/LT.png $(DESTDIR)$(INSTALLATION_PREFIX)/share/pixmaps/fieldworks-flex.png
+	install -m 644 Src/LexText/LexTextExe/LT64.png $(DESTDIR)$(INSTALLATION_PREFIX)/share/icons/hicolor/64x64/apps/fieldworks-flex.png
+	install -m 644 Src/LexText/LexTextExe/LT128.png $(DESTDIR)$(INSTALLATION_PREFIX)/share/icons/hicolor/128x128/apps/fieldworks-flex.png
+	desktop-file-install --dir $(DESTDIR)$(INSTALLATION_PREFIX)/share/applications Lib/linux/fieldworks-applications.desktop
+	desktop-file-install --dir $(DESTDIR)$(INSTALLATION_PREFIX)/share/applications Lib/linux/unicodechareditor.desktop
 
 install-packagemetadata:
-	install -d $(DESTDIR)/usr/share/appdata
-	install -m 644 DistFiles/Linux/fieldworks-applications.desktop.appdata.xml $(DESTDIR)/usr/share/appdata
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/share/appdata
+	install -m 644 DistFiles/Linux/fieldworks-applications.desktop.appdata.xml $(DESTDIR)$(INSTALLATION_PREFIX)/share/appdata
 
 install: install-tree install-menuentries l10n-install install-packagemetadata
 
 install-package: install install-COM
-	$(DESTDIR)/usr/lib/fieldworks/cpol-action pack
+	$(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/cpol-action pack
 
 install-package-fdo: install-tree-fdo install-COM
 
 uninstall: uninstall-menuentries
-	rm -rf $(DESTDIR)/usr/bin/flex $(DESTDIR)/usr/lib/fieldworks $(DESTDIR)/usr/share/fieldworks
+	rm -rf $(DESTDIR)$(INSTALLATION_PREFIX)/bin/flex $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks
 
 uninstall-menuentries:
-	rm -f $(DESTDIR)/usr/share/pixmaps/fieldworks-flex.png
-	rm -f $(DESTDIR)/usr/share/applications/fieldworks-applications.desktop
-	rm -f $(DESTDIR)/usr/share/icons/hicolor/64x64/apps/fieldworks-flex.png
-	rm -f $(DESTDIR)/usr/share/icons/hicolor/128x128/apps/fieldworks-flex.png
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/share/pixmaps/fieldworks-flex.png
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/share/applications/fieldworks-applications.desktop
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/share/icons/hicolor/64x64/apps/fieldworks-flex.png
+	rm -f $(DESTDIR)$(INSTALLATION_PREFIX)/share/icons/hicolor/128x128/apps/fieldworks-flex.png
 
 installable-COM-all:
 	mkdir -p $(COM_DIR)/installer$(ARCH)
 	-(cd $(COM_DIR)/installer$(ARCH) && [ ! -e Makefile ] && autoreconf -isf .. && \
-		../configure --prefix=/usr/lib/fieldworks --libdir=/usr/lib/fieldworks)
+		../configure --prefix=$(INSTALLATION_PREFIX)/lib/fieldworks --libdir=$(INSTALLATION_PREFIX)/lib/fieldworks)
 	$(MAKE) -C$(COM_DIR)/installer$(ARCH) all
 
 installable-COM-clean:
@@ -418,20 +419,20 @@ l10n-clean:
 
 l10n-install:
 	if [ "$(FW_PACKAGE_DEBUG)" = "true" ]; then find "$(BUILD_ROOT)/DistFiles" "$(DESTDIR)"; fi
-	install -d $(DESTDIR)/usr/lib/fieldworks
-	install -d $(DESTDIR)/usr/share/fieldworks/CommonLocalizations
-	install -d "$(DESTDIR)/usr/share/fieldworks/Language Explorer/Configuration"
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks
+	install -d $(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/CommonLocalizations
+	install -d "$(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/Language Explorer/Configuration"
 	for LOCALE in $(LOCALIZATIONS); do \
-		DESTINATION=$(DESTDIR)/usr/lib/fieldworks-l10n-$${LOCALE,,} ;\
+		DESTINATION=$(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks-l10n-$${LOCALE,,} ;\
 		install -d $$DESTINATION ;\
 		install -m 644 Output/Release/$$LOCALE/*.dll $$DESTINATION/ ;\
 		install -m 644 "$(BUILD_ROOT)/DistFiles/CommonLocalizations/Palaso.$$LOCALE.xlf" $$DESTINATION/ ;\
 		install -m 644 "$(BUILD_ROOT)/DistFiles/CommonLocalizations/Chorus.$$LOCALE.xlf" $$DESTINATION/ ;\
 		install -m 644 "$(BUILD_ROOT)/DistFiles/Language Explorer/Configuration/strings-$$LOCALE.xml" $$DESTINATION/ ;\
-		ln -sf ../fieldworks-l10n-$${LOCALE,,} $(DESTDIR)/usr/lib/fieldworks/$$LOCALE ;\
-		ln -sf ../../../lib/fieldworks-l10n-$${LOCALE,,}/Palaso.$$LOCALE.xlf "$(DESTDIR)/usr/share/fieldworks/CommonLocalizations/Palaso.$$LOCALE.xlf" ;\
-		ln -sf ../../../lib/fieldworks-l10n-$${LOCALE,,}/Chorus.$$LOCALE.xlf "$(DESTDIR)/usr/share/fieldworks/CommonLocalizations/Chorus.$$LOCALE.xlf" ;\
-		ln -sf ../../../../lib/fieldworks-l10n-$${LOCALE,,}/strings-$$LOCALE.xml "$(DESTDIR)/usr/share/fieldworks/Language Explorer/Configuration/strings-$$LOCALE.xml" ;\
+		ln -sf ../fieldworks-l10n-$${LOCALE,,} $(DESTDIR)$(INSTALLATION_PREFIX)/lib/fieldworks/$$LOCALE ;\
+		ln -sf ../../../lib/fieldworks-l10n-$${LOCALE,,}/Palaso.$$LOCALE.xlf "$(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/CommonLocalizations/Palaso.$$LOCALE.xlf" ;\
+		ln -sf ../../../lib/fieldworks-l10n-$${LOCALE,,}/Chorus.$$LOCALE.xlf "$(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/CommonLocalizations/Chorus.$$LOCALE.xlf" ;\
+		ln -sf ../../../../lib/fieldworks-l10n-$${LOCALE,,}/strings-$$LOCALE.xml "$(DESTDIR)$(INSTALLATION_PREFIX)/share/fieldworks/Language Explorer/Configuration/strings-$$LOCALE.xml" ;\
 	done
 
 # End localization section
-- 
2.25.1

