# WeSay Flatpak package build specification
#
# Copyright (c) 2021 SIL International. MIT License.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

app-id: org.sil.WeSay

# org.gnome.Platform provides some pieces that we would need to manually specify
# if we use org.freedesktop.Platform.
runtime: org.gnome.Platform
# Target a runtime that is most similar to Ubuntu 20.04, for which we can easily
# build and test on without flatpak.
runtime-version: "3.36"
sdk: org.gnome.Sdk

# TODO Note that WeSay wries to write to these locations
# ~/.mono/registry/CurrentUser/software/wesay
# ~/.config/WeSay
# ~/WeSay
# ~/.local/share/WeSay
# ~/.local/share/SIL/WeSay Configuration Tool
# ~/.local/share/SIL/WeSay.ConfigTool.exe_Url_7e5be1cbac899b94146387aca5d1128238e2538f
# ~/.local/share/SIL/WeSay.ConfigTool.exe_Url_13c62d6283f40fa747e42cac2b151f29bd79d24f
# CLEAN COMMAND: rm -rf ~/WeSay ~/.mono/registry/CurrentUser/software/wesay ~/.config/WeSay ~/.local/share/WeSay ~/.local/share/SIL/WeSay*

finish-args:
  - --socket=x11
  - --share=ipc
  # WeSay can synchronize project data over the network with other users.
  - --share=network
  # Writing system definition files. Shared with other applications.
  - --filesystem=xdg-data/SIL/WritingSystemRepository:create
  # Directory for libpalaso GlobalMutex.
  - --filesystem=xdg-run/sil-lock:create
  # Older directory for libpalaso GlobalMutex until update libpalaso.
  - --filesystem=/var/lock
  # WeSay can synchronize data over the network or by USB Flash Drives. WeSay
  # uses NDesk D-Bus (https://github.com/sillsdev/dbus-sharp) to query for
  # avaliable USB Flash Drives.
  - --socket=system-bus
  - --env=MONO_PREFIX=/app

# TODO Note that 3 commands are provided: wesay wesay-config chorus
command: wesay

modules:
  - name: wesay
    build-options:
      env:
        #PREFIX: "/app"
        MONO_PREFIX: "/app"
        INSTALLATION_PREFIX: "/app"
        RUNMODE: "BUILDINGPACKAGE"
        # BUILD_CONFIG settings include Debug and Release.
        BUILD_CONFIG: "Release"
    # build-commands:
    #   - |
    #     # Run the rest in bash rather than sh.
    #     bash <<_
    #     set -xueo pipefail
    #     # Apply outstanding FwBuildTasks code changes, if any.
    #     cd ${FW_ROOT_PATH}/Build/Src/FwBuildTasks
    #     ${FW_ROOT_PATH}/Build/run-in-environ msbuild

    #     cd ${FW_ROOT_PATH}
    #     Build/run-in-environ make \
    #       BUILD_TYPE=${BUILD_TYPE} \
    #       BUILD_CONFIG=${BUILD_CONFIG} \
    #       disableDownloads=true \
    #       build-package-for-flatpak

    #     cd ${FW_ROOT_PATH}
    #     Build/run-in-environ make \
    #       BUILD_TYPE=${BUILD_TYPE} \
    #       BUILD_CONFIG=${BUILD_CONFIG} \
    #       disableDownloads=true \
    #       install-for-flatpak

    #     mv -v /app/share/applications/{fieldworks-applications,org.sil.FieldWorks}.desktop
    #     perl -pi -e 's/Icon=fieldworks-flex/Icon=org.sil.FieldWorks/g' \
    #       /app/share/applications/org.sil.FieldWorks.desktop
    #     mv -v /app/share/icons/hicolor/128x128/apps/{fieldworks-flex,org.sil.FieldWorks}.png
    #     mv -v /app/share/icons/hicolor/64x64/apps/{fieldworks-flex,org.sil.FieldWorks}.png
    cleanup:
      - "/include"
      - "/lib/*/include"
      - "*.a"
    sources:
      - type: git
        # Build from main repo
        #url: https://github.com/sillsdev/wesay.git
        #branch: develop
        #tag: TODO
        #commit: TODO

        # Build from commit still in review
        #url: https://github.com/sillsdev/wesay.git
        #commit:

        # Build from local repo
        url: ../wesay
        branch: task/linux
      - type: shell
        commands:
          - |
            tee autogen <<< '#!/bin/bash'
            chmod +x autogen
            tee configure <<< '#!/bin/bash'
            chmod +x configure
      # Use local nuget packages
      - type: shell
        commands:
          - |
            set -xueo pipefail
            #mkdir -p nuget-sources
            #mv --verbose *.nupkg nuget-sources
            tee nuget.config <<< '<?xml version="1.0" encoding="utf-8"?>
            <configuration>
              <packageSources>
                <add key="LocalNugetPackages" value="'$(pwd)/nuget-sources'" />
              </packageSources>
              <disabledPackageSources>
                <add key="nuget.org" value="true" />
              </disabledPackageSources>
            </configuration>'
      # Regenerate: ./compose-nuget-sources wesay-sources-nuget.yml nuget-sources $(find ../wesay -name packages.config)
      - wesay-sources-nuget.yml
      - type: shell
        # Extract nuget packages.
        commands:
          - |
            set -xueo pipefail
            for package in nuget-sources/*.nupkg; do
              mkdir -p "src/packages/$(basename "${package}" .nupkg)" &&
                unzip "${package}" \
                  -d "src/packages/$(basename "${package}" .nupkg)"
            done
            # Handle oddity in CommonServiceLocator package versioning
            mv src/packages/CommonServiceLocator.1.0.0 src/packages/CommonServiceLocator.1.0
            cp -va src/packages .
      - type: shell
        # Diagnostics
        commands:
          - |
            set -xueo pipefail
            pwd
            env
            find
    modules:
      - name: dbus-glib
        # For Gecko.
        cleanup:
          - "/share/gtk-doc"
          - "/include"
          - "*.a"
        sources:
          - type: git
            url: https://salsa.debian.org/debian/dbus-glib.git
            tag: debian/0.110-5
            commit: 722fc1041fc8d975774b17a6cff0ec260e666172
      - name: libxklavier
        buildsystem: autotools
        cleanup:
          - "/include"
          - "*.a"
        sources:
          - type: git
            url: https://salsa.debian.org/gnome-team/libxklavier.git
            commit: 4cd9bfe37a52961270d588b37e617cbce8217e5a
            tag: debian/5.4-4
          - type: shell
            commands:
              - |
                for PATCH_FILE in $(cat debian/patches/series); do
                  patch -p1 -i debian/patches/${PATCH_FILE}
                done
      - name: gtkmm2.4
        config-opts:
          - --disable-documentation
        cleanup:
          - "/include"
          - "/lib/*/include"
          - "*.a"
        sources:
          - type: archive
            url: https://download.gnome.org/sources/gtkmm/2.24/gtkmm-2.24.5.tar.xz
            sha256: 0680a53b7bf90b4e4bf444d1d89e6df41c777e0bacc96e9c09fc4dd2f5fe6b72
        modules:
          - name: atkmm1.6
            buildsystem: meson
            config-opts:
              - -Dbuild-documentation=false
              - -Dbuild-demos=false
              - -Dbuild-tests=false
            cleanup:
              - "/include"
              - "/lib/*/include"
              - "*.a"
            sources:
              - type: git
                url: https://gitlab.gnome.org/GNOME/atkmm.git
                tag: "2.28.1"
                commit: 5d8721c5619b0d9c904f669f712db1d9ca7107f9
            modules:
              - name: glibmm2.4
                buildsystem: meson
                config-opts:
                  - -Dbuild-documentation=false
                  - -Dbuild-demos=false
                  - -Dbuild-tests=false
                cleanup:
                  - "/include"
                  - "/lib/*/include"
                  - "*.a"
                  - "*.la"
                sources:
                  - type: git
                    url: https://gitlab.gnome.org/GNOME/glibmm.git
                    tag: "2.64.2"
                    commit: e775940669cb6d93f37ddc2b4cd7da446dfa482c
                modules:
                  - name: libsigc++-2.0
                    config-opts:
                      - --disable-documentation
                    cleanup:
                      - "/include"
                      - "/lib/*/include"
                      - "*.a"
                    sources:
                      - type: git
                        url: https://github.com/libsigcplusplus/libsigcplusplus.git
                        tag: "2.10.2"
                        commit: 06fabac512bf81164d5b01f877927cb39e9db864
                    modules:
                      - name: mm-common
                        buildsystem: meson
                        cleanup:
                          - "*"
                        sources:
                          - type: archive
                            url: https://download.gnome.org/sources/mm-common/1.0/mm-common-1.0.2.tar.xz
                            sha256: a2a99f3fa943cf662f189163ed39a2cfc19a428d906dd4f92b387d3659d1641d
          - name: pangomm
            buildsystem: meson
            config-opts:
              - -Dbuild-documentation=false
              - -Dbuild-demos=false
              - -Dbuild-tests=false
            cleanup:
              - "/include"
              - "/lib/*/include"
              - "*.a"
            sources:
              - type: git
                url: https://gitlab.gnome.org/GNOME/pangomm.git
                tag: "2.42.1"
                commit: 7dfc6c3372faaa4a7c492d08f09881b02095145b
            modules:
              - name: cairomm
                config-opts:
                  - --disable-documentation
                  - --disable-demos
                  - --disable-tests
                cleanup:
                  - "/include"
                  - "/lib/*/include"
                  - "*.a"
                sources:
                  - type: git
                    url: https://github.com/freedesktop/cairomm.git
                    branch: cairomm-1-12
                    commit: e9ef515b7b8db5b4f024ddfefe5dfc03f2b8ccea
          - name: gtk+2.0
            config-opts:
              - --disable-documentation
              - --disable-demos
              - --disable-tests
            cleanup:
              - "/share/gtk-doc"
              - "/include"
              - "/lib/*/include"
              - "*.a"
            sources:
              - type: archive
                url: http://archive.ubuntu.com/ubuntu/pool/main/g/gtk+2.0/gtk+2.0_2.24.32.orig.tar.xz
                sha256: b6c8a93ddda5eabe3bfee1eb39636c9a03d2a56c7b62828b359bf197943c582e
            modules:
              - name: gdk-pixbuf
                buildsystem: meson
                cleanup:
                  - "/libexec/installed-tests"
                  - "/include"
                  - "*.a"
                sources:
                  - type: git
                    url: https://salsa.debian.org/gnome-team/gdk-pixbuf.git
                    commit: 3f0d33cab4fe203f5c8cbeed13af70346ee2b5b4
                    tag: debian/2.40.0+dfsg-1
                  - type: shell
                    commands:
                      - |
                        for PATCH_FILE in $(cat debian/patches/series); do
                          patch -p1 -i debian/patches/${PATCH_FILE}
                        done
      - name: mono5-sil
        cleanup:
          - "/include"
          - "*.a"
          - "/bin/gtk-demo"
          - "/bin/monodis"
          - "/bin/monograph"
          - "/bin/pedump"
          - "/lib/mono/2*"
          - "/lib/mono/3*"
          - "/lib/mono/4.5/dim"
          - "/lib/mono/4.5/mcs*"
          - "/lib/mono/4.5/Microsoft.CodeAnalysis.*"
          - "/lib/mono/gac/Microsoft.Build.Engine"
          - "/lib/mono/gac/Microsoft.Build"
          - "/lib/mono/gac/monodoc"
          - "/lib/mono/msbuild"
          - "/lib/mono/xbuild-frameworks"
          - "/lib/mono/xbuild"
          - "/lib/monodoc"
        sources:
          - type: git
            url: https://github.com/sillsdev/mono.git
            # Past sil/5.16.0.179
            commit: 3bb5d7c98c3bc6f977bc7960f3a541bc0acba715
          - type: archive
            # Update URL by doing: cd .../path/to/mono-repo && .../determine-monolite-url
            url: https://download.mono-project.com/monolite/monolite-linux-1051600011-latest.tar.gz
            sha512: b48bb273f5a9107f9bb9795d47277aeaaeb458588a6e011676bb9a152b83759f305cf1031a5e74a62145854ef17026cb1aa20ea9adb5e6b15f275b9d6af585db
            dest: mcs/class/lib/monolite-linux/1051600011
        modules:
          - name: python-2.7
            # Build Python 2 without cleaning away parts that we still need,
            # like shared-modules/python2.7 does.
            config-opts:
              - --enable-shared
              - --with-system-expat
              - --with-system-ffi
              - --enable-unicode=ucs4
            post-install:
              - chmod 644 ${FLATPAK_DEST}/lib/libpython2.7.so.1.0
            cleanup:
              - "/lib/python2.7/test"
              - "/lib/python2.7/unittest"
              - "/lib/python2.7/distutils/tests"
              - "/lib/python2.7/idlelib/idle_test"
              - "/lib/python2.7/lib2to3"
              - "/include"
              - "*.a"
              - "*.o"
            sources:
              - type: archive
                url: https://www.python.org/ftp/python/2.7.18/Python-2.7.18.tar.xz
                sha256: b62c0e7937551d0cc02b8fd5cb0f544f9405bafc9a54d3808ed4594812edef43
      - name: gtk-sharp
        config-opts:
          - --disable-gtk-doc
          - --disable-man
        cleanup:
          - "/lib/monodoc"
          - "/include"
          - "*.a"
        sources:
          - type: git
            url: https://github.com/sillsdev/gtk-sharp.git
            branch: develop
            commit: fcf1dd40d4892be309dd450bcda2026ddece4480
          - type: script
            commands:
              - NOCONFIGURE=1 ./bootstrap-2.12
      - name: mono5-sil-msbuild
        # It was challenging to build msbuild from source. Other projects
        # appear to fetch binaries rather than build msbuild. Following that.
        buildsystem: simple
        build-commands:
          # Extract opt/mono5-sil/* into /app/
          - |
            for package in *.deb; do
              mkdir "${package}-dir" &&
                (cd "${package}-dir" && ar x ../"${package}") &&
                tar -C /app -x -f "${package}-dir"/data.tar.xz \
                  --strip-components=3 ./opt/mono5-sil
            done
          # Use same-character-count path to /app since some binary files are
          # going to be modified too.
          - perl -pi -e 's#/opt/mono5-sil#/./././././app#g' /app/bin/*
        cleanup:
          # Can't clean '*' because that seems to result in /app/bin/mono being
          # absent.
          - "/lib/mono/msbuild"
          - "/lib/mono/xbuild"
        sources:
          - type: file
            url: http://linux.lsdev.sil.org/ubuntu/pool/main/m/mono5-sil-msbuild/mono5-sil-msbuild_15.8+xamarinxplat.2018.07.31.22.43-0xamarin5+ubuntu1804b1_all.deb
            sha256: 758274d8bc438f325fc5fc808c0482ab50eb2bdaf02f61747888e190760753de
      - name: libgdiplus
        build-options:
          prefix: /app
          env:
            MONO_PREFIX: /app
        config-opts:
          - --with-pango
        cleanup:
          - "/include"
          - "*.a"
        sources:
          - type: git
            url: https://github.com/sillsdev/libgdiplus
            tag: merge/5.6.0
            commit: b9c581ba87da89651d5ec56c5da0960ab739a63a
        modules:
          - name: giflib
            buildsystem: simple
            build-commands:
              # libgdiplus needs giflib to have GifQuantizeBuffer
              - patch -i debian/patches/revert-GifQuantizeBuffer-remove-from-lib.patch
              # Skip building documentation
              - "echo >doc/Makefile all:"
              - make PREFIX=/app
              - make PREFIX=/app install
            cleanup:
              - "/include"
              - "*.a"
            sources:
              - type: git
                url: https://salsa.debian.org/deiv-guest/giflib.git
                commit: de2120737dbbeb00728054232a21c6b03c1ae687
      - name: icu-fw
      # TODO debian/rules mentions icu-dev. change to that? or keep icu-fw?
        # FW ICU should install to paths like
        # /app/lib/fieldworks/lib/libicuuc.so . The icu-fw package debian/rules
        # file installs bin/* and sbin/* to icu-bin/ . The FieldWorks build
        # expects icu-config to be there, such as in _init.mak.lnx and environ.
        config-opts:
          - --prefix=/app/lib/fieldworks
          - --bindir=/app/lib/fieldworks/icu-bin
          - --sbindir=/app/lib/fieldworks/icu-bin
        subdir: source
        cleanup:
          - "/lib/*/include"
        sources:
          - type: git
            url: https://github.com/sillsdev/icu.git
            branch: FieldWorks
            commit: f648b14cd744202c24648c5f76847621721e1ae9
      - name: xchm
        # Help file viewer
        cleanup:
          - "/include"
          - "*.a"
          - "/share/icons"
          - "/share/applications"
        sources:
          - type: git
            url: https://github.com/rzvncj/xCHM
            # Version 1.31 is used in Ubuntu 20.04.
            tag: "1.31"
            commit: e983d11fd546c961501f736b2c6f93178c92fa97
          - type: patch
            # xchm would otherwise need to write to files ~/.xchmXXXXXX and
            # ~/.xchm. This won't be needed after upgrading to a newer xchm
            # version and wxWidgets v3.1.1+.
            path: patches/xchm/no-config.patch
        modules:
          - name: chmlib
            cleanup:
              - "/include"
              - "*.a"
            sources:
              - type: git
                url: https://github.com/jedwing/CHMLib
                # Latest commit, from 2009-07-03.
                commit: 2bef8d063ec7d88a8de6fd9f0513ea42ac0fa21f
              - type: script
                commands:
                  - autoreconf --install
          - name: wxWidgets
            cleanup:
              - "/include"
              - "/lib/wx/include"
              - "*.a"
            sources:
              - type: git
                url: https://github.com/wxWidgets/wxWidgets
                # v3.0.4 is used in Ubuntu 20.04.
                # v3.1.1+ is needed for xchm to write to XDG_CONFIG_HOME.
                # However, v3.1.0 appears to introduce a problem rendering the
                # chm html that still needs investigating. v3.0.5.1 still
                # worked, rendering the html.
                tag: v3.0.4
                commit: 721d62adde3f8ba8704a9cf56efeb050f652dfbf
      - name: fonts-sil-charis
        # From https://software.sil.org/charis/download/previous-versions/
        buildsystem: simple
        build-commands:
          - mkdir -p /app/share/fonts/truetype/charis
          - cp -a *.ttf /app/share/fonts/truetype/charis
        sources:
          - type: archive
            url: https://software.sil.org/downloads/r/charis/CharisSIL-5.000.zip
            sha512: f85da6c9b93c0ef81617241219b208ca262c12fcecae1d447163b7aff31ea8bfc3f09636dcfc0a322c86201a0d551288884e4017fded5bb71bbb54c8093faaed
      # - name: xdg-utils
      #   # To get `xdg-settings` command.
      #   sources:
      #     - type: git
      #       url: https://gitlab.freedesktop.org/xdg/xdg-utils.git
      #       tag: v1.1.3
      #       commit: 159fc37075db2decf446f453fe1a796da6921aad
      #   modules:
      #     - name: xmlto
      #       cleanup:
      #         - '*'
      #       sources:
      #         - type: git
      #           url: https://pagure.io/xmlto.git
      #           commit: b128bdcf7b15865aaae49635a1dcbcaca07fc6ef
      #         - type: script
      #           commands:
      #             - autoreconf --install
      #     - name: links2
      #       post-install:
      #         - ln -s links /app/bin/elinks
      #       cleanup:
      #         - '*'
      #       sources:
      #         - type: git
      #           url: https://salsa.debian.org/debian/links2.git
      #           tag: upstream/2.25
      #           commit: 2ee900d6ffc10d95181e78d0aa06e335a06e0cd7

